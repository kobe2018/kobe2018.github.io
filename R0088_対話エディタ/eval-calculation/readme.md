# eval-calculation.js

## 概要

eval-calculation.js は引数として与えられた計算式の文字列を評価し、計算結果となる数値を返します。

## 設置方法

外部スクリプトとしてeval-calculation.jsを指定して下さい。

```HTML
<script src="./eval-calculation.js"></script>
``

## 使い方

evalCalculation()の第一引数に計算式となる文字列を指定する事で計算結果となる数値を返します。

```JavaScript
evalCalculation('2*3');  // 6
```

数字と演算子の間に空白を入れても構いません。

```JavaScript
evalCalculation('2 * 3 + 5 * 6 / 2');  // 21
```

負の数を解釈できます。

```JavaScript
evalCalculation('-3 * -4');  // 12
```

.1 は 0.1 として評価されます。

```JavaScript
evalCalculation('.1 * 5');  // 0.5
```

JavaScript では IEEE754 の仕様規定によって浮動小数点演算で丸め誤差が生じますが、evalCalculation() は内部的に整数に変換してから演算する為、丸め誤差は生じません。

```JavaScript
0.6 * 3;                     // 1.7999999999999998
evalCalculation('0.6 * 3');  // 1.8
```

乗算と除算の複合式では左から順番に演算するのが通常ですが、左から演算していくと途中で循環小数になってしまい、演算結果が正しくならないかもしれません。
そこで乗算を先に演算する事で、一部の循環小数を経由する式に対して、循環小数を経由せずに演算するようにします。
例えば、下記式は `(1 * 3) / 3` に置き換えて演算します。

```JavaScript
evalCalculation('1 / 3 * 3');  // 1
```

括弧付きの計算式も正しく解釈します。

```JavaScript
evalCalculation('(1+(2+3*4))/5');  // 3
```

`eval()` と違い、JavaScriptコードを評価出来ませんので、安全に計算式を評価できます。

```JavaScript
eval('alert("hoge")');            // alert() が実行される
evalCalculation('alert("hoge")'); // SyntaxError: An expression starts with an unexpected token: a
```

## 仕様/既知の問題

- 整数に変換する事で整数演算している為、IEEE754 の制約があります。つまり、内部処理で「-9007199254740991 ～ 9007199254740991」を超える整数演算をした場合には正確な値を算出できません。
- パフォーマンス上の問題。現行仕様では「式文字列から演算可能な四則演算式を探して演算後、括弧を取り外していく方式」を採用しています。この方式は、何度も式文字列から全文検索する為、効率が悪い可能性があります。正確にはベンチマークをとる必要がありますが、「文字列の構文解析を一度に行い、優先順位の高い順番で演算していく方式」が現行仕様よりも高速に処理できる可能性があります。

## 更新履歴

ver.1.0.0 (2017/09/19)
 - 括弧付きの式に対応した
 - 不正な式に対し、`SyntaxError` を返すようにした

ver.0.9.2 (2017/09/19)
 - 除算に先んじて乗算を演算するようにした ~~(※更新後にver.0.9.1で既に実現できていた事に気が付きましたが、せっかく作ったのでコードを残します)~~ ver.0.9.1では実現できていませんでした。現代のブラウザでは `0.3333333333333333 * 3=== 1` が成立する事から ver.0.9.1 の挙動を誤解していました。意味のある処理の為、ver.0.9.2 で更新したコードは後継版でも残しました。

ver.0.9.1 (2016/11/11)
 - 初版

## 参考リンク

- [eval-calculation.js: 計算式の文字列を評価する - GitHub Gist](https://gist.github.com/think49/54b074cab2145efddb48765652c74710)
- [calculator.js: 計算式を表示するシンプルな電卓 - GitHub Gist](https://gist.github.com/think49/6aedea62463a741dde0a9ad2c9aa672e)
