<!DOCTYPE HTML>
<html lang="ja">
<head>
<title>ドット絵作成エディタ002</title>
<meta charset="utf-8" />

<link rel="stylesheet" type="text/css" href="css_text_editor_canvas.css"><style></style>
<script >
"use strict";
let [esc_flag,clear_flag]=[true,false];
let code = "🟥";
window.addEventListener("DOMContentLoaded",function(){
    let element = document.querySelector('#ID_canvas01');
    let ID_svg = document.querySelector('#ID_svg');

    const ID_canvas01 = document.getElementById("ID_canvas01");
    if (ID_canvas01.getContext) {
      const context001 = ID_canvas01.getContext("2d");//2次元描画
      context001.fillRect(100,0,280,180);//塗りつぶされた四角形
      //context001.font = "24px GeoMathMono";
      context001.font = '600 24px "GeoMathDotMono",serif';
      context001.fillText(`🟥🟧🟨🟩🟦🟪🟫⬛⬜░▒▓`, 24, 48);
      context001.fillText(`🌲🌳🪾🪵🌵⛰🏔🪨🧱`, 24, 72);
      context001.fillText(`🧱🧱🧱🧱🧱🧱🧱🧱🧱🧱`, 24, 96);
      
    }

    document.querySelector('body').style.backgroundColor = 'white';
    
    //keydown(element,element2);
    //keydown(element);
    //keyup(element);
    //function_touch_event();


    document.querySelector('body').addEventListener('keydown', function(eve) {
      if(eve.ctrlKey){
        element.style.pointerEvents = "none";
      } 
    }, false);

    document.querySelector('body').addEventListener('keyup', function(eve) {
      //code=eve.keyCode
      //console.log(code);
      if(!eve.ctrlKey){
        element.style.pointerEvents = "auto";
      } 
    }, false);
    document.querySelector('#ID_canvas01').addEventListener('mouseup', function(eve) {

      //avaScript でテキストエリア内のカーソルのある位置に文字列を挿入する方法
      //https://qiita.com/noraworld/items/d6334a4f9b07792200a5

      const ID_canvas01 = document.getElementById("ID_canvas01");
    if (ID_canvas01.getContext) {
      const context001 = ID_canvas01.getContext("2d");//2次元描画
      context001.fillText(eve.pageX,20, 20);
      context001.fillText(eve.offsetX,20, 40);
      
      context001.fillText(code, eve.offsetX,eve.offsetY);
    }
      let sentence = document.querySelector('#ID_canvas01');
    
      

      //console.log(sentence,sentence.innerHTML.getSelection());い
      //console.log(sentence,window.getSelection().getRangeAt(0).getBoundingClientRect());
      

      let len      = [...ID_canvas01.value].length;//utf-8用表現→1056と出る。
      let pos_start    = ID_canvas01.selectionStart;
      let pos_end      = ID_canvas01.selectionEnd;

      console.log("len ",len);
     // console.log("sentence ",sentence.value,pos_start,pos_end,code);
      console.log("pos_start ",pos_start,pos_end,code);


      let before   = sentence.value.substring(0, pos_start);//substrは使わない。
      //console.log("before ",before);
      let insert_word =  code;//insert_word;挿入したい文字列;
      //let after    = sentence.value.substring(pos_start+1, len);
      //let after    = sentence.value.substring(pos_start+1);
      
      //alert( sentence.value.substring(pos_start,pos_end+1));
      console.log("sentence.value.substring(pos_start,pos_end+1) ",sentence.value.substring(pos_start,pos_end+1));
      console.log("sentence.value.substring(pos_start,pos_end+1).split( /[\uD800-\uDBFF][\uDC00-\uDFFF]/g ) ",sentence.value.substring(pos_start,pos_end+2).split( /[\uD800-\uDBFF][\uDC00-\uDFFF]/g ).length);
      
      
      let after ="";
      if(sentence.value.substring(pos_start,pos_end+2).split( /[\uD800-\uDBFF][\uDC00-\uDFFF]/g ).length >=2){
        console.log( "サロゲートです");
        after    = sentence.value.substring(pos_end+2);//サロゲートベアの場合
      }else{
        after    = sentence.value.substring(pos_end+1);//通常の場合
      }
      // console.log("after ",after);
        
      sentence = before + insert_word + after;
      ID_canvas01.value = sentence;

      //console.log(len,pos,word,code);
       
    }, false);


    document.querySelector('#ID_1F7E5').addEventListener('click', function(e) {code="🟥";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F7E7').addEventListener('click', function(e) {code="🟧";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F7E8').addEventListener('click', function(e) {code="🟨";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F7E9').addEventListener('click', function(e) {code="🟩";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F7E6').addEventListener('click', function(e) {code="🟦";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F7EA').addEventListener('click', function(e) {code="🟪";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F7EB').addEventListener('click', function(e) {code="🟫";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID__2B1B').addEventListener('click', function(e) {code="⬛";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID__2B1C').addEventListener('click', function(e) {code="⬜";document.querySelector('#ID_mode01').innerHTML =code}, false);

    document.querySelector('#ID_1F3FB').addEventListener('click', function(e) {code="🏻";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F3FC').addEventListener('click', function(e) {code="🏼";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F3FD').addEventListener('click', function(e) {code="🏾";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F3FE').addEventListener('click', function(e) {code="🏾";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F3FF').addEventListener('click', function(e) {code="🏿";document.querySelector('#ID_mode01').innerHTML =code}, false);

    document.querySelector('#ID_1F332').addEventListener('click', function(e) {code="🌲";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F333').addEventListener('click', function(e) {code="🌳";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F333').addEventListener('click', function(e) {code="🌳";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1FABE').addEventListener('click', function(e) {code="🪾";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1FAB5').addEventListener('click', function(e) {code="🪵";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F335').addEventListener('click', function(e) {code="🌵";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID__26F0').addEventListener('click', function(e) {code="⛰";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F3D4').addEventListener('click', function(e) {code="🏔";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1FAA8').addEventListener('click', function(e) {code="🪨";document.querySelector('#ID_mode01').innerHTML =code}, false);
    document.querySelector('#ID_1F9F1').addEventListener('click', function(e) {code="🧱";document.querySelector('#ID_mode01').innerHTML =code}, false);


  }, true);

</script>
</head>
<body>
モード：<span id="ID_mode00"></span><br>
選択文字：<span id="ID_mode01"></span><br>
<span id="ID_selection">
<br>
<input type ="button" value ="クリック">
<input type ="button" value ="矩形選択">
<input type ="button" value ="罫線表示"><br>
<input type ="button" value ="全塗">
<input type ="button" value ="レイヤー">
<input type ="button" value ="元に戻す">
</span>

<span id="ID_span01">
<div class="button-group">
  <input type ="button" value ="🟥" id="ID_1F7E5">
  <input type ="button" value ="🟧" id="ID_1F7E7">
  <input type ="button" value ="🟨" id="ID_1F7E8">
  <input type ="button" value ="🟩" id="ID_1F7E9">
  <input type ="button" value ="🟦" id="ID_1F7E6">
  <input type ="button" value ="🟪" id="ID_1F7EA">
  <input type ="button" value ="🟫" id="ID_1F7EB">
  <input type ="button" value ="⬛" id="ID__2B1B">
  <input type ="button" value ="⬜" id="ID__2B1C">
  <input type ="button" value ="░" id="">
  <input type ="button" value ="▒" id="">
  <input type ="button" value ="▓" id="">
</div>
<div class="button-group">
  <input type ="button" value ="🏻" id="ID_1F3FB">
  <input type ="button" value ="🏼" id="ID_1F3FC">
  <input type ="button" value ="🏾" id="ID_1F3FD">
  <input type ="button" value ="🏾" id="ID_1F3FE">
  <input type ="button" value ="🏿" id="ID_1F3FF">
  
  <input type ="button" value ="🔴" id="">
  <input type ="button" value ="🟠" id="">
  <input type ="button" value ="🟡" id="">
  <input type ="button" value ="🟢" id="">
</div>
<div class="button-group">
  <input type ="button" value ="🌲" id="ID_1F332">
  <input type ="button" value ="🌳" id="ID_1F333">
  <input type ="button" value ="🪾" id="ID_1FABE">
  <input type ="button" value ="🪵" id="ID_1FAB5">
  <input type ="button" value ="🌵" id="ID_1F335">&nbsp;
  <input type ="button" value ="⛰" id="ID__26F0">
  <input type ="button" value ="🏔" id="ID_1F3D4">
  <input type ="button" value ="🪨" id="ID_1FAA8">
  <input type ="button" value ="🧱" id="ID_1F9F1">
</div>
<input type ="button" value ="🐺" id=""><input type ="button" value ="🐖">
<input type ="button" value ="💣" id="">
<input type ="button" value ="🏢" id=""><br>
<input type ="button" value ="⭱" id=""><input type ="button" value ="⭰"><input type ="button" value ="⭲"><input type ="button" value ="⭳">
<input type ="button" value ="⤒"><input type ="button" value ="⤓">
<input type ="button" value ="⍏"><input type ="button" value ="⍅"><input type ="button" value ="⍆"><input type ="button" value ="⍖"><br>
<input type ="button" value ="⇦"><input type ="button" value ="⇧"><input type ="button" value ="⇨"><input type ="button" value ="⇩"><input type ="button" value ="⇳"><input type ="button" value ="⬀"><input type ="button" value ="⬁"><input type ="button" value ="⬂"><input type ="button" value ="⬃"><input type ="button" value ="⬄"><br>
<input type ="button" value ="⬅"><input type ="button" value ="⬆"><input type ="button" value ="⬇"><input type ="button" value ="⮕"><input type ="button" value ="⬈"><input type ="button" value ="⬉"><input type ="button" value ="⬊"><input type ="button" value ="⬋"><input type ="button" value ="⬌"><input type ="button" value ="⬍">
</span>

<canvas id="ID_canvas01" width="500" height="400">
  canvas要素をサポートしていません。
</canvas>
<body>
</html>